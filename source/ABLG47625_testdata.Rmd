---
title: "Methylation test data for sample ABLG 47625"
author: "charles-gumbi"
date: "2025-08-07"
output:
  html_document:
    df_print: paged
---

# Loading packages 
```{r packages}
library(ggplot2)
library(dplyr)
library(ggplot2)
library(dplyr)
library(readr)
```

# Reading methylation data calls  

```{r loading data}
df <- read.delim("~/pop_methylation/Methyl47625/ABLG47625_pop_genome/em-seq_output/methylDackelExtracts/mbias/ABLG-47625_1_combined_mbias.tsv", sep = "\t", header = TRUE)
ctrls <- read.delim("~/pop_methylation/Methyl47625/ABLG47625_controls_genome/em-seq_output/methylDackelExtracts/mbias/ABLG-47625_1_combined_mbias.tsv", sep = "\t", header = TRUE)
```

# Summarizing context-specific methylation from pop genome alignments

```{r methylation_pop_aligned}
df_summary <- df %>%
  group_by(context) %>%
  summarise(
    mean_methylation = mean(100 * nMethylated / (nMethylated + nUnmethylated), na.rm = TRUE),
    se_methylation = sd(100 * nMethylated / (nMethylated + nUnmethylated), na.rm = TRUE) / sqrt(n())
  ) %>%
  mutate(
    context = factor(context, levels = c("CpG", "CHG", "CHH")),
    ymin = mean_methylation - se_methylation,
    ymax = mean_methylation + se_methylation
  )

# Plot barplot with error bars
ggplot(df_summary, aes(x = context, y = mean_methylation, fill = context)) +
  geom_bar(stat = "identity", width = 0.6) +
  geom_errorbar(aes(ymin = ymin, ymax = ymax), width = 0.2) +
  ylab("Mean Methylation (%)") +
  xlab("Context") +
  ggtitle("Mean Methylation Percentage with Error Bars") +
  scale_fill_manual(values = c("CpG" = "#1f77b4", "CHG" = "#2ca02c", "CHH" = "#d62728")) +
  theme_minimal()
```

# Summarizing context-specific methylation from control genome alignments

```{r methylation_controls_aligned}
df_summary <- ctrls %>%
  group_by(context) %>%
  summarise(
    mean_methylation = mean(100 * nMethylated / (nMethylated + nUnmethylated), na.rm = TRUE),
    se_methylation = sd(100 * nMethylated / (nMethylated + nUnmethylated), na.rm = TRUE) / sqrt(n())
  ) %>%
  mutate(
    context = factor(context, levels = c("CpG", "CHG", "CHH")),
    ymin = mean_methylation - se_methylation,
    ymax = mean_methylation + se_methylation
  )

# Plot barplot with error bars
ggplot(df_summary, aes(x = context, y = mean_methylation, fill = context)) +
  geom_bar(stat = "identity", width = 0.6) +
  geom_errorbar(aes(ymin = ymin, ymax = ymax), width = 0.2) +
  ylab("Mean Methylation (%)") +
  xlab("Context") +
  ggtitle("Mean Methylation Percentage with Error Bars") +
  scale_fill_manual(values = c("CpG" = "#1f77b4", "CHG" = "#2ca02c", "CHH" = "#d62728")) +
  theme_minimal()
```

# Summarizing control-specific methylation from control genome alignments 

```{r controls_methylation}
#Calculate % methylation per row
methylation_by_chr <- ctrls %>%
  mutate(percent_methylation = 100 * nMethylated / (nMethylated + nUnmethylated)) %>%
  filter(!is.na(percent_methylation)) %>%
  group_by(chr, context) %>%
  summarise(
    mean_methylation = mean(percent_methylation, na.rm = TRUE),
    se_methylation = sd(percent_methylation, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  )

#Sort chromosomes
methylation_by_chr <- methylation_by_chr %>%
  arrange(desc(mean_methylation)) %>%
  mutate(chr = factor(chr, levels = unique(chr)))

# Plot barplot
ggplot(methylation_by_chr, aes(x = chr, y = mean_methylation, fill = chr)) +
  geom_bar(stat = "identity") +
  #geom_errorbar(aes(ymin = mean_methylation - se_methylation,
   #                 ymax = mean_methylation + se_methylation),
    #            width = 0.2) +
  ylab("Methylation (%)") +
  xlab("Control") +
  ggtitle("Methylation percentage across sequence of controls") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  guides(fill = "none")

```


# Methylated control

```{r puc19}
methylated_control <- read.delim("~/pop_methylation/Methyl47625/puc19/ABLG-47625_CpG.bedGraph", header = FALSE, comment.char = "t")
# names on the bed file 
#col 1. The chromosome/contig/scaffold name
#col 2. The start coordinate
#col 3. The end coordinate
#col 4. The methylation percentage rounded to an integer
#col 5. The number of alignments/pairs reporting methylated bases
#col 6. The number of alignments/pairs reporting unmethylated bases

# Assign column names (based on your earlier description)

colnames(methylated_control) <- c("chrom", "start", "end", "methylation_percentage", "methylated_count", "unmethylated_count")
# View the first few rows
head(methylated_control)

# Average methylation
mean(methylated_control$methylation_percentage, na.rm = TRUE)
###28.91713

ggplot(methylated_control, aes(x = start, y = methylation_percentage)) +
    geom_line() +
    labs(
      title = paste("Mbias Plot for puc19c (methylated control)"),
      x = "Read Position",
      y = "Methylation percentage (%)"
    ) +
    theme_minimal()

```
# Umethylated control

```{r lambda}
unmethylated_control <- read.delim("~/pop_methylation/Methyl47625/lambda/ABLG-47625_CpG.bedGraph", header = FALSE, comment.char = "t")
# names on the bed file 
#col 1. The chromosome/contig/scaffold name
#col 2. The start coordinate
#col 3. The end coordinate
#col 4. The methylation percentage rounded to an integer
#col 5. The number of alignments/pairs reporting methylated bases
#col 6. The number of alignments/pairs reporting unmethylated bases

# Assign column names (based on your earlier description)
colnames(unmethylated_control) <- c("chrom", "start", "end", "methylation_percentage", "methylated_count", "unmethylated_count")
# View the first few rows
head(unmethylated_control)

# Average methylation
mean(unmethylated_control$methylation_percentage, na.rm = TRUE)
###11.62983

ggplot(unmethylated_control, aes(x = start, y = methylation_percentage)) +
    geom_line() +
    labs(
      title = paste("Mbias Plot for lambda (unmethylated control)"),
      x = "Read Position",
      y = "Methylation percentage (%)"
    ) +
    theme_minimal()

```


